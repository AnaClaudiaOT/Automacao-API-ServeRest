name: Cypress Tests

on:
  push:
    branches:
      - main
  pull_request:

jobs:
  cypress-run:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 16

      - name: Install dependencies
        run: npm ci

      - name: Fix Cypress permissions
        run: chmod +x ./node_modules/.bin/cypress

      - name: Install Cypress
        run: npx cypress install

      - name: Clean reports directory
        run: rm -rf cypress/reports/*

      - name: Run Cypress tests
        run: npx cypress run --reporter cypress-mochawesome-reporter --reporter-options reportDir=cypress/reports,overwrite=false,html=true,json=true

      - name: List JSON files
        run: ls -lh cypress/reports

      - name: Check if JSON files exist
        id: check-json
        run: |
          if [ -z "$(ls -A cypress/reports/*.json 2>/dev/null)" ]; then
            echo "No JSON files found, skipping report generation."
            echo "skip_report=true" >> $GITHUB_ENV
          else
            echo "skip_report=false" >> $GITHUB_ENV
          fi

      - name: Generate Mochawesome report
        if: env.skip_report == 'false'
        run: |
          npx mochawesome-merge cypress/reports/*.json > cypress/reports/combined.json
          npx mochawesome-report-generator cypress/reports/combined.json --reportDir cypress/reports --inline

      - name: Upload Mochawesome Report
        if: env.skip_report == 'false'
        uses: actions/upload-artifact@v3
        with:
          name: mochawesome-report
          path: cypress/reports/mochawesome.html

      - name: Generate Test Summary
        if: env.skip_report == 'false'
        run: |
          PASSED=$(jq '[.results[] | select(.suites[].tests[].state == "passed")] | length' cypress/reports/combined.json)
          FAILED=$(jq '[.results[] | select(.suites[].tests[].state == "failed")] | length' cypress/reports/combined.json)
          PENDING=$(jq '[.results[] | select(.suites[].tests[].state == "pending")] | length' cypress/reports/combined.json)
          SKIPPED=$(jq '[.results[] | select(.suites[].tests[].state == "skipped")] | length' cypress/reports/combined.json)
          DURATION=$(jq '[.results[].suites[].tests[].duration] | add / 1000' cypress/reports/combined.json)

          echo "## Cypress Test Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Result | Passed ✅ | Failed ❌ | Pending ✋ | Skipped ↩️ | Duration 🕗 |" >> $GITHUB_STEP_SUMMARY
          echo "| ------ | --------- | --------- | --------- | ---------- | ----------- |" >> $GITHUB_STEP_SUMMARY
          echo "| Count  | $PASSED   | $FAILED   | $PENDING  | $SKIPPED   | ${DURATION}s |" >> $GITHUB_STEP_SUMMARY

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Detailed Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          jq -r '.results[].suites[].tests[] | "#### \(.title)\n* **State**: \(.state)\n* **Duration**: \(.duration)ms\n* **Error**: \(.err.message // "None")\n"' cypress/reports/combined.json >> $GITHUB_STEP_SUMMARY
